<link rel="import" href="../components/core-elements/core-elements.html">
<link rel="import" href="../components/paper-elements/paper-elements.html">
<link rel="import" href="../components/core-icons/av-icons.html">

<polymer-element name="tomato-timer" attributes="duration">

  <template>
    <style>    
      :host {
        width: 100%;
        height: 100%;
        box-sizing: border-box;
      }
      #div {
        font-size: 40px;
        background-color: #FF5252;
        color: white;
        padding: 5px 30px;
        -webkit-app-region: no-drag;
      }

      paper-fab {
          position: absolute;
          bottom: 35px;
          right: 35px;
      }

      paper-fab.button-play {
          background-color: yellow;
      }
    </style>
    <core-card layout vertical>
            <div id="div" vertical layout center>
                <span>{{time}}</span>
            </div>
            <paper-ripple fit></paper-ripple>
            <paper-shadow z="1"></paper-shadow>
    </core-card>
  </template>

  <script>
    (function(Polymer) {
        'use strict';

        function Timer(duration, onElapsed, onFinished) {
            var timer = this;
            var clock;

            function padDigit(digit) {
                return ((digit < 10) ? ("0" + digit) : digit);
            } 

            function formatTime(time) {
                var minutes = parseInt(time / 60);
                var seconds = time % 60;
                return padDigit(minutes) + ':' + padDigit(seconds);
            }
            
            function elapsed(time) {
                if(timer.onElapsed) {
                timer.onElapsed(timer.getValue());
                }
            }
            
            timer.duration = duration;
            timer.time = duration;
            timer.onFinished = onFinished;
            timer.onElapsed = onElapsed;
            
            timer.getValue = function() {
                return formatTime(timer.time);
            }
            
            timer.start = function() {
                clearTimeout(clock);
                timer.time = timer.duration;

                elapsed(formatTime(timer.time));
                timer.resume();
            };
            
            timer.stop = function() {
                clearTimeout(clock);
                timer.time = timer.duration;
                elapsed(formatTime(timer.time));
            }
            
            timer.resume = function() {
                timer.time--;
                elapsed(formatTime(timer.time));
                clock = setTimeout(timer.resume, 1000);

                if(timer.time <= 0) {
                    timer.pause();
                }
            }
            
            timer.pause = function() {
                clearTimeout(clock);
            }
        };

        Polymer('tomato-timer', {
            ready: function() {
                var self = this;
                self.timer = new Timer(self.duration, function(time) {
                    self.time = time;
                });

                self.timer.start();
            }
        });
    })(Polymer);

  </script>

</polymer-element>
